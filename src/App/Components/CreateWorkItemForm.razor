@using Develix.AzureDevOps.Connector.Model;
@using Develix.AzureDevOps.Connector.Service;
@using System.Diagnostics.CodeAnalysis;
@using System.ComponentModel.DataAnnotations;

<MudPaper Elevation="2" Class="pa-3">
    <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />
        <MudCard>
            <MudCardContent>
                <MudTextField Label="Project name"
                              @bind-Value="model.Project"
                              DebounceInterval="500"
                              OnDebounceIntervalElapsed="HandleProjectFieldDebounced"
                              For="() => model.Project" />
                <WorkItemTypeSelect WorkItemTypes="workItemTypes" @bind-Value="model.WorkItemType" For="() => model.WorkItemType" />
                <MudTextField Label="Title" @bind-Value="model.Title" For="() => model.Title" />
                <AreaPathSelect AreaPaths="areaPaths" @bind-Value="model.AreaPath" For="() => model.AreaPath" />
                <MudTextField Label="Assigned to" @bind-Value="model.AssignedTo" For="() => model.AssignedTo" />
                <MudNumericField Label="Parent WI ID" @bind-Value="model.ParentWorkItemId" />
            </MudCardContent>
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit">Create</MudButton>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudPaper>

@code {
    [Inject]
    [NotNull]
    private IWorkItemService? workItemService { get; set; }

    private string project = string.Empty;
    private IReadOnlyList<WorkItemType> workItemTypes = Array.Empty<WorkItemType>();
    private IReadOnlyList<AreaPath> areaPaths = Array.Empty<AreaPath>();
    private Model model = new();

    private async Task HandleProjectFieldDebounced(string value)
    {
        var workItemTypesResult = await workItemService.GetWorkItemTypes(value);
        workItemTypes = workItemTypesResult.Valid
            ? workItemTypesResult.Value
            : Array.Empty<WorkItemType>();

        var areaPathsResult = await workItemService.GetAreaPaths(value, 3);
        areaPaths = areaPathsResult.Valid
            ? areaPathsResult.Value
            : Array.Empty<AreaPath>();
    }

    private void OnValidSubmit(EditContext context)
    {
        StateHasChanged();
        var template = new WorkItemCreateTemplate(model.Title, model.WorkItemType.Name, model.Project)
            {
                AreaId = model.AreaPath?.Id,
                AssignedTo = model.AssignedTo,
                ParentWorkItemId = model.ParentWorkItemId,
                Project = model.Project,
                Title = model.Title,
                WorkItemType = model.WorkItemType.Name,
            };
        workItemService.CreateWorkItem(template);
    }


    private class Model
    {
        [Required]
        [StringLength(int.MaxValue, MinimumLength = 1)]
        public string Title { get; set; } = string.Empty;

        [Required]
        public WorkItemType WorkItemType { get; set; } = WorkItemType.Invalid;

        [Required]
        [StringLength(int.MaxValue, MinimumLength = 1)]
        public string Project { get; set; } = string.Empty;

        public AreaPath? AreaPath { get; set; }

        public string? AssignedTo { get; set; }

        public int? ParentWorkItemId { get; set; }
    }
}
